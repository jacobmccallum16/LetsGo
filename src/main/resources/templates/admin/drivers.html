<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<title>Let's Go! - Admin - Drivers</title>
	<th:block th:insert="~{fragments/scripts}"></th:block>
</head>
<body class="vh-100 d-flex flex-column">
<th:block th:insert="~{fragments/navbar}"></th:block>
<div class="d-flex flex-fill">
	<th:block th:insert="~{fragments/sidebar}"></th:block>
	<main class="container-sm text-center flex-grow-1">
		<h1>Drivers</h1>
		<table class="table table-striped table-hover table-sm align-middle">
			<thead class="table-dark">
			<tr>
				<th>ID</th>
				<th>First<br>Name</th>
				<th>Last<br>Name</th>
				<th>Trips<br>Driven</th>
				<th>Times<br>Rated</th>
				<th>Safety<br>Score</th>
				<th>Status</th>
				<th>Trips</th>
				<th>Vehicles</th>
				<th>Account</th>
				<th>Edit</th>
			</tr>
			</thead>
			<tbody class="table-group-divider border-indigo-subtle">
			<tr th:each="d:${drivers}" th:object="${d}">
				<td th:text="*{driverId}"></td>
				<td th:text="*{user.firstName}"></td>
				<td th:text="*{user.lastName}"></td>
				<td th:text="*{tripsDriven}"></td>
				<td th:text="*{timesRated}"></td>
				<td><div class="alert fw-bold" th:text="${#numbers.formatDecimal(d.driverSafetyScore,1,1)}"
				         th:classappend="${d.driverSafetyScore} > 0 ? (${d.driverSafetyScore} >= 2 ? (${d.driverSafetyScore} >= 3 ? (${d.driverSafetyScore} >= 4 ?
				         'alert-green' : 'alert-yellow') : 'alert-orange') : 'alert-red') : 'alert-secondary'"></div></td>
				<td>
					<a th:if="*{driverStatus == 'Active'}" class="btn btn-sm btn-green active">Active</a>
					<a th:if="*{driverStatus == 'Inactive'}" class="btn btn-sm btn-yellow active">Inactive</a>
					<a th:if="*{driverStatus == 'Banned'}" class="btn btn-sm btn-red active">Banned</a>
				</td>
				<td><button type="button" class="btn btn-sm btn-cyan" data-bs-toggle="modal" data-bs-target="#tripsModal" th:data-driver-id="*{driverId}" onclick="loadTripsModal(this)">View Trips (modal)</button></td>
				<td><button type="button" class="btn btn-sm btn-teal" data-bs-toggle="modal" data-bs-target="#vehiclesModal" th:data-driver-id="*{driverId}" onclick="setDriverIdAndLoadVehiclesModal(this)">Vehicles</button></td>
				<td><a class="btn btn-sm btn-outline-primary" th:href="@{/admin/viewAccount(id=*{user.userId})}">View Account</a></td>
				<td><a class="btn btn-sm btn-outline-teal" th:href="@{/admin/drivers/editDriver(id=*{driverId})}">Edit Driver</a></td>
			</tr>
			</tbody>
		</table>
		<div class="modal fade" id="tripsModal" tabindex="-1" aria-labelledby="tripsModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
				<div class="modal-content">
					<div class="modal-header">
						<h1 class="modal-title fs-5" id="tripsModalLabel">Trips by driver</h1>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<table class="table table-striped table-hover table-sm align-middle">
							<thead class="table-dark">
							<tr>
								<th></th>
								<th>From</th>
								<th>To</th>
								<th></th>
							</tr>
							</thead>
							<tbody class="table-group-divider border-indigo-subtle">
							</tbody>
						</table>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
					</div>
				</div>
			</div>
		</div>
	</main>
</div>
<script>
	const modalTitle = document.querySelector('#tripsModal h1.modal-title');
	const modalTBody = document.querySelector("#tripsModal .modal-body tbody");
	const tripStatusStyle = {
		Completed: "btn-dark", Planned: "btn-teal", Requested: "btn-indigo", Cancelled: "btn-red"
	}
	const months = [,"Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
	const days = [,"1st", "2nd", "3rd", "4th", "5th", "6th", "7th", "8th", "9th", "10th",
	"11th", "12th", "13th", "14th", "15th", "16th", "17th", "18th", "19th", "20th",
	"21st", "22nd", "23rd", "24th", "25th", "26th", "27th", "28th", "29th", "30th", "31st"];
	const hours = ["12", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11",
		"12", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11"]
	const minutes = ["00", "01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12", "13", "14",
		"15", "16", "17", "18", "19", "20", "21", "22", "23", "24", "25", "26", "27", "28", "29",
		"30", "31", "32", "33", "34", "35", "36", "37", "38", "39", "40", "41", "42", "43", "44",
		"45", "46", "47", "48", "49", "50", "51", "52", "53", "54", "55", "56", "57", "58", "59"]
	const suffix = [" am", " am", " am", " am", " am", " am", " am", " am", " am", " am", " am", " am",
		" pm", " pm", " pm", " pm", " pm", " pm", " pm", " pm", " pm", " pm", " pm", " pm"];
	async function loadTripsModal(button) {
		let driverId = button.getAttribute('data-driver-id');
		let dataObj = await fetch('/api/getTripsByDriver/' + driverId);
		let dataText = await dataObj.text();
		let data = JSON.parse(dataText);
		let titleHtml = 'Trips by driver';
		let tripsHtml = '';
		data.forEach((trip) => {
			titleHtml = 'Trips by <b>' + trip.driver.fullName + '</b>';
			tripsHtml += '<tr>';
				tripsHtml += '<td rowspan="2"><img src="http://localhost:8082/routeImages/' + trip.route.routeImageSource + '" height="100px"></td>';
				tripsHtml += '<td>' + trip.route.locationStart + '</td>';
				tripsHtml += '<td>' + trip.route.locationEnd + '</td>';
				tripsHtml += '<td><a class="btn btn-sm ' + tripStatusStyle[trip.tripStatus] + ' active">' + trip.tripStatus + '</a></td>';
			tripsHtml += '</tr>';
			tripsHtml += '<tr>';
				tripsHtml += '<td>' + hours[trip.departureTime[0]] + ':' + minutes[trip.departureTime[1]] + suffix[trip.departureTime[0]] + ' on ' + months[trip.date[1]] + ' ' + days[trip.date[2]] + ', ' + trip.date[0] + '</td>';
				tripsHtml += '<td>' + hours[trip.arrivalTime[0]] + ':' + minutes[trip.arrivalTime[1]] + suffix[trip.arrivalTime[0]] + ' on ' + months[trip.date[1]] + ' ' + days[trip.date[2]] + ', ' + trip.date[0] + '</td>';
				tripsHtml += '<td><a class="btn btn-sm btn-cyan" href="/admin/trips/editTrip?id=' + trip.tripId + '">Edit</a></td>';
			tripsHtml += '</tr>';
		});
		modalTitle.innerHTML = titleHtml;
		modalTBody.innerHTML = tripsHtml;
	}
</script>
<th:block th:insert="~{fragments/modals/vehicles}"></th:block>
</body>
</html>